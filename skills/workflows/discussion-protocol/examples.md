# discussion-protocol Examples

ディスカッション実行時の4つのシナリオ。

## シナリオ 1: 正常系（3ラウンド完走 -- 標準ディスカッション）

### タイムラインフロー

```
[T+0s]  リーダー（モデレーター）: TeamCreate で discuss-{topic-slug} チームを作成
        判断: TeamCreate 利用可能 → チームモードで実行

[T+5s]  リーダー: ユーザーに通知
        "Agent Team モードでディスカッションを開始します。
         5名のメンバー（3名 + devils-advocate + モデレーター）が参加します。"

[T+10s] リーダー: トピックに応じてロールを動的選出
        例: 技術選定トピック
        - performance-expert
        - security-expert
        - maintainability-expert
        - devils-advocate（固定）

[T+15s] リーダー: 4体のチームメイトをスポーン
        全員に reference.md のテンプレート + トピック + コンテキストを付与

--- Round 1: Position（並列実行）---

[T+20s] リーダー → 全メンバー: "Round 1 - Position を開始してください。
        他メンバーの意見を参照せず、独立して立場を表明してください。"

[T+30s] 各メンバー: 独立して Position を提出（SendMessage → リーダー）
        - L1: メンバー間の直接通信なし（アンカリング防止）
        - リーダーが全 Position を受信するまで待機

[T+60s] リーダー: 全 Position を受信
        収束判定: DIVERGENT（4つの異なる立場）
        判断: Challenge Round に進行

[T+65s] リーダー → 全メンバー: 全員の Position を配布
        "Round 2 - Challenge を開始します。
         他メンバーの提案への批判に特化してください。
         L1: 同意・賛同の表明は禁止です。"

--- Round 2: Challenge ---

[T+70s] 各メンバー: 他メンバーの提案を批判（SendMessage → リーダー）
        - devils-advocate: 最も支持されている意見を優先的に批判
        - 各メンバー: 弱点 + 失敗シナリオ + 代替案を提出

[T+120s] リーダー: 全 Challenge を受信
         収束判定: NARROWING（共通点が見え始めている）
         判断: 未解決の重要な対立あり → Synthesis Round を実施

[T+125s] リーダー → 全メンバー: 全員の Challenge を配布
         "Round 3 - Synthesis を開始します。
          批判を踏まえた立場修正と折衷案を提示してください。"

--- Round 3: Synthesis ---

[T+130s] 各メンバー: 立場修正 + 折衷案を提出
         - 2名が立場変更（Position 変遷として記録）
         - devils-advocate: 批判を維持しつつ建設的妥協案を提示

[T+180s] リーダー: 全 Synthesis を受信
         収束判定: CONVERGING

--- 最終立場回収 ---

[T+185s] リーダー → 全メンバー: "最終立場を報告してください（500語以内）。"

[T+220s] リーダー: 全最終立場を受信
         結果統合フォーマットで統合レポートを作成

--- チームクリーンアップ ---

[T+230s] リーダー: 各チームメイトに shutdown_request
         結果ファイルを docs/specs/{feature}-discussion-{topic}.md に保存

[T+240s] リーダー: ユーザーに統合結果を提示
         "ディスカッション結果をまとめました。
          合意事項と未解決の対立点を以下に示します。"
```

## シナリオ 2: 早期収束（2ラウンドで終了 -- --quick 相当）

### タイムラインフロー

```
[T+0s]   リーダー: チーム作成、メンバースポーン（シナリオ 1 と同様）

--- Round 1: Position ---

[T+30s]  各メンバー: Position を提出

[T+60s]  リーダー: 全 Position を受信
         収束判定: CONVERGING（初期段階で立場が近い）
         判断: 重要な対立なし → Challenge Round をスキップ、Synthesis に直行

[T+65s]  リーダー → 全メンバー: 全員の Position を配布
         "立場が近いため Challenge をスキップします。
          Synthesis Round で最終的な統合を行ってください。"

--- Round 2: Synthesis（Challenge スキップ）---

[T+70s]  各メンバー: 統合提案を提出
         - devils-advocate: 「合意が早すぎる」と警告、追加の検討点を提示

[T+120s] リーダー: 全 Synthesis を受信
         収束判定: CONSENSUS

--- 偽の合意検出 ---

[T+125s] リーダー: 同意バイアス検証を実施
         1. 各メンバーの合意根拠を比較
         2. 根拠の多様性を確認
         結果: 根拠が多様（異なる角度から同じ結論）→ 真の合意と判定

[T+130s] リーダー: ユーザーに結果提示 + 同意バイアス警告
         "全メンバーが合意に到達しました。
          Unanimous agreement detected. Verify diversity of reasoning.
          合意根拠の類似度: LOW（多様な根拠）"
```

## シナリオ 3: 偽の合意検出 -- 追加ラウンド

### タイムラインフロー

```
[T+0s]   リーダー: チーム作成、メンバースポーン

--- Round 1-2: Position → Challenge ---
（シナリオ 1 と同様）

--- Round 3: Synthesis ---

[T+180s] リーダー: 全 Synthesis を受信
         収束判定: CONSENSUS

--- 偽の合意検出 ---

[T+185s] リーダー: 同意バイアス検証を実施
         1. 各メンバーの合意根拠を比較
         2. 根拠が同質的（全員が同じ理由で同意）→ 「表面的合意」と判定

[T+190s] リーダー → devils-advocate: "合意根拠が同質的です。
         追加の反論を提出してください。"

[T+210s] devils-advocate: 追加反論を提出
         - 見落とされていた視点を指摘
         - 新たな失敗シナリオを提示

[T+215s] リーダー: ユーザーに警告付きで結果提示
         "全メンバーが合意に到達しましたが、
          合意根拠が同質的なため追加検証を実施しました。

          Unanimous agreement detected. Verify diversity of reasoning.
          合意根拠の類似度: HIGH（同質的）
          devils-advocate の追加反論: [反論内容]

          この合意を採用しますか？ それとも議論を延長しますか？"
```

### ユーザー選択肢

```
1. 合意を採用 → 結果ファイルに保存
2. 議論を延長 → 追加ラウンドを実施
3. 新しい視点を追加 → メンバーを追加してやり直し
```

## シナリオ 4: フォールバック系（Agent Team 利用不可）

### タイムラインフロー

```
[T+0s]  リーダー: TeamCreate ツールの利用可能性を確認
        判断: 利用不可 → フォールバック通知

[T+5s]  リーダー: ユーザーに通知
        "Agent Team ツールは現在の環境で利用できません。
         サブエージェント（Task tool）モードでディスカッションを実行します。

         機能的な差異:
         - ラウンド間の動的な立場変更追跡は簡略化されます
         - 各メンバーは独立して全ラウンドの立場を一括提出します
         - 結果の多角性は同等です"

[T+10s] リーダー: 4体のサブエージェントを並列起動 (Task tool)
        各サブエージェントに以下を含むプロンプトを付与:
        - ロール定義 + トピック + コンテキスト
        - 全ラウンド（Position → Challenge → Synthesis）を
          1回のプロンプトで一括実行する指示
        - 構造化出力フォーマット

[T+15s] サブエージェント: 独立して全ラウンドを実行
        （エージェント間の直接通信なし）
        各サブエージェントが Position → 自己 Challenge → Synthesis を
        内部で完結して最終立場を返す

[T+90s] リーダー: 全結果を受信
        - 4体分の最終立場を統合
        - 相互批判はないため、リーダーが対立点を識別
        - 結果統合フォーマットで統合レポートを作成

[T+100s] リーダー: ユーザーに結果提示
```

### フォールバック時のサブエージェントプロンプト概要

```
あなたは {role_name} として以下のトピックについて分析します。

以下の3段階で分析を行い、構造化された結果を返してください:

1. Position（初期立場）: あなたの専門領域からの初期見解
2. Self-Challenge: 自分の立場への批判（弱点、失敗シナリオ、代替案）
3. Final Position: 批判を踏まえた最終立場

出力フォーマット:
## {role_name} Analysis
### Position: [初期立場]
### Self-Challenge: [自己批判]
### Final Position: [最終立場]
### 確信度: HIGH / MEDIUM / LOW
### 譲れない点: [妥協不可の部分]
### 残存リスク: [未解決の懸念]
```

## シナリオ間の比較

| 項目 | 正常系 (3R) | 早期収束 (2R) | 偽の合意 | フォールバック |
|-----|------------|-------------|---------|-------------|
| ラウンド数 | 3 | 2 | 3+追加 | 1（一括） |
| 相互批判 | あり | 部分的 | あり+追加 | なし（自己批判） |
| 収束判定 | 毎ラウンド | 毎ラウンド | 毎ラウンド | リーダー判定 |
| 偽合意検出 | 該当なし | 実施 | 実施+警告 | 非対応 |
| 立場変遷追跡 | 完全 | 完全 | 完全 | なし |
| 所要時間目安 | 4-5分 | 2-3分 | 5-7分 | 2-3分 |
