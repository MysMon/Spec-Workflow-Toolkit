# SDD ワークフロー例

仕様駆動開発の実際の使用例。

## 例 1: ユーザー認証機能

### フェーズ 1: 曖昧さフェーズ（ユーザーリクエスト）

```
ユーザー: 「ユーザー認証を追加して」
```

これは曖昧。明確化が必要。

### フェーズ 2: 明確化フェーズ（インタビュー）

```
Claude: ユーザー認証の追加をお手伝いします。いくつか要件を確認させてください。

質問:
1. どの認証方式が必要ですか？
   - メール/パスワードのみ
   - OAuth（Google、GitHub 等）
   - マジックリンク / パスワードレス
   - 上記すべて

2. ロールベースのアクセス制御は必要ですか？
   - はい、複数のロール（管理者、ユーザー等）
   - いいえ、認証済み vs 匿名のみ

3. セッション戦略は？
   - JWT トークン
   - サーバーサイドセッション
   - 特に希望なし（推奨してほしい）

ユーザー: Google の OAuth、シンプルな認証（ロールなし）、JWT トークン
```

### フェーズ 3: 定義フェーズ（仕様書）

```markdown
# 機能: ユーザー認証

## 概要
ユーザーが Google OAuth 経由で認証し、保護された機能にアクセスできるようにする。

## ユーザーストーリー
| ID | ストーリー | 優先度 |
|----|-----------|--------|
| US-001 | ユーザーとして、別のパスワードが不要なように Google でサインインしたい | P0 |
| US-002 | ユーザーとして、ブラウザセッション間でログイン状態を維持したい | P0 |
| US-003 | ユーザーとして、共有デバイスでアカウントを保護するためにサインアウトしたい | P0 |

## 機能要件
| ID | 要件 | 優先度 | 受け入れ基準 |
|----|------|--------|-------------|
| FR-001 | システムは Google OAuth サインインを許可する | P0 | ユーザーが「Google でサインイン」をクリック → リダイレクト → 認証済みで戻る |
| FR-002 | システムは認証成功時に JWT を発行する | P0 | JWT にユーザー ID、メール、有効期限を含む |
| FR-003 | システムは有効期限前にトークンを更新する | P0 | 有効期限の 5 分以内にトークンを更新 |
| FR-004 | システムはサインアウトを許可する | P0 | サインアウトでトークンをクリアし、ホームに戻る |

## 非機能要件
| ID | カテゴリ | 要件 |
|----|----------|------|
| NFR-001 | セキュリティ | トークンを httpOnly Cookie に保存 |
| NFR-002 | セキュリティ | CSRF 保護を有効化 |
| NFR-003 | パフォーマンス | 認証フロー < 3 秒 |

## スコープ外
- メール/パスワード認証
- ロールベースのアクセス制御
- 多要素認証
- アカウントリンク（複数プロバイダー）

## 承認
[x] プロダクトオーナー: 承認済み
[x] テックリード: 承認済み
```

### フェーズ 4: 実行フェーズ

```
Claude: OAuth 実装のために backend-specialist に委任中...

backend-specialist が実装:
- /api/auth/google（OAuth を開始）
- /api/auth/callback（OAuth コールバックを処理）
- /api/auth/refresh（トークンを更新）
- /api/auth/logout（セッションをクリア）

Claude: UI のために frontend-specialist に委任中...

frontend-specialist が実装:
- サインインボタンコンポーネント
- 認証コンテキスト/プロバイダー
- 保護されたルートラッパー
- サインアウト機能
```

### フェーズ 5: 検証フェーズ

```
Claude: テストのために qa-engineer に委任中...

作成されたテスト:
- ユニット: トークン生成、バリデーション
- 統合: OAuth フロー、リフレッシュフロー
- E2E: 完全なサインインジャーニー

Claude: レビューのために security-auditor に委任中...

セキュリティ監査:
- httpOnly Cookie にトークン保存
- CSRF 保護
- State パラメータで OAuth の CSRF を防止
- 推奨: 認証エンドポイントにレート制限を追加
```

---

## 例 2: 仕様の逸脱処理

実装中に仕様のギャップが見つかった場合の対処:

```
backend-specialist: FR-001 の実装中に、ユーザーの Google アカウントの
メールアドレスが変更された場合の処理が必要であることが判明しました。
これは仕様に記載されていません。

選択肢:
A) メールを不変として扱う（Google ID のみ使用）
B) サインインごとにメールを更新
C) 手動レビューのためにフラグを立てる

Claude: これは仕様のギャップです。ユーザーに確認中...

ユーザー: 選択肢 A を使用 - メールを不変として扱い、Google ID をユーザー識別子とする。

Claude: 仕様を更新: FR-005: システムは Google ID（メールではなく）を
一意のユーザー識別子として使用する。
```

---

## 例 3: 「とにかく作って」への対処

ユーザーが仕様をスキップしたい場合:

```
ユーザー: ダッシュボードを作って、仕様は不要。

Claude: 素早く進めたいお気持ちは理解できます。しかし、仕様なしでは:
- 間違ったものを作る可能性がある
- 手戻りが発生する可能性が高い
- 受け入れ基準がない

最小限の仕様を作るために 3 つの簡単な質問をさせてください:

1. ダッシュボードに何のデータを表示すべきですか？
2. 主なユーザーは誰ですか？
3. 成功とは何ですか？

これは 5 分で完了し、何時間もの手戻りを節約します。

ユーザー: OK。売上指標を表示、営業チーム向け、成功 = レポート依頼が来なくなること。

Claude: 了解！最小限の仕様です:

# 機能: 売上ダッシュボード

## 課題
営業チームが手動でレポートを依頼している。セルフサービスダッシュボードが必要。

## 要件
- [ ] 日次/週次/月次の売上合計を表示
- [ ] 製品、地域、担当者でフィルタ
- [ ] CSV エクスポート

## 成功基準
- [ ] 営業チームが自分で質問に回答できる
- [ ] レポート依頼が 80% 削減

この仕様で進めてよいですか？
```

---

## アンチパターン例

### 悪い例: 要件の推測

```
ユーザー: 検索機能を追加して

Claude: Elasticsearch を使用した全文検索、ファセットフィルタリング、
オートコンプリート候補、検索分析を追加します...

[誤り: これらの要件をすべて推測した]
```

### 良い例: 要件の明確化

```
ユーザー: 検索機能を追加して

Claude: 検索の追加をお手伝いします。必要なものを理解させてください:

1. 何を検索対象にしますか？
   - 製品のみ
   - 製品とブログ記事
   - すべて

2. どの検索機能が必要ですか？
   - 基本的なキーワード検索
   - フィルタ（価格、カテゴリ等）
   - オートコンプリート候補
   - 関連性ランキング付き全文検索

3. 規模は？
   - < 1000 件（シンプルな検索で十分）
   - 1000-100K 件（インデックスが必要）
   - > 100K 件（専用の検索サービスが必要）
```

### 悪い例: ゴールドプレーティング

```
# FR-001 の実装: ユーザー名の表示

Claude: 以下も追加します:
- アバターアップロード
- カスタムテーマ
- プロフィールページ
- ソーシャルリンク
- 自己紹介エディタ

[誤り: FR-001 のみが依頼された]
```

### 良い例: スコープ規律

```
# FR-001 の実装: ユーザー名の表示

Claude: 仕様通りに FR-001 を実装します。
注意: 将来アバターサポートが必要になる可能性に気付きました。
次のイテレーションのプレースホルダー要件を追加しますか？
```
