---
description: "ドキュメントとコードの乖離を監査 - 古くなったドキュメント、欠落セクション、不整合を検出"
argument-hint: "[パス or --scope api|readme|all]"
allowed-tools: Read, Write, Glob, Grep, Bash, AskUserQuestion, Task, TodoWrite
---

# /doc-audit - ドキュメント乖離検出

## Language Mode

すべての出力は日本語で行う。詳細は `language-enforcement` スキルを参照。

---

ドキュメントをコードと照合して体系的に監査し、古くなった内容、欠落セクション、不整合を検出する。

## 設計原則

1. **コードが正**: コードの動作が唯一の正（Source of Truth）であり、ドキュメントはそれと一致すべき
2. **適切なスコープ**: 影響の大きいドキュメントに監査を集中させる
3. **実行可能な指摘**: 明確な修正案付きの具体的な問題を報告する
4. **影響度による優先順位**: ユーザー向けドキュメントを優先する

---

## 使用するとき

- リリース前にドキュメントが最新であることを確認
- 大規模なリファクタリング後
- PR レビュープロセスの一環として
- 定期的なドキュメントヘルスチェック

## 入力形式

```bash
# 特定のドキュメントファイルを監査
/doc-audit docs/API.md

# スコープ別に監査
/doc-audit --scope api       # API ドキュメント
/doc-audit --scope readme    # README ファイル
/doc-audit --scope all       # すべてのドキュメント

# 特定のコードに対するドキュメントを監査
/doc-audit --for src/services/auth.ts
```

---

## 実行手順

### フェーズ 1: ドキュメント探索

**ゴール:** 監査対象のドキュメントファイルを特定する。

**code-explorer にドキュメント探索を委任する:**

```
code-explorer エージェントを起動:
タスク: コードベース内のドキュメントファイルを探索
分析内容:
- すべてのマークダウンファイル（.git/、node_modules/ を除く）
- 一般的なドキュメント配置場所（README.md、docs/、CONTRIBUTING.md、CHANGELOG.md、API.md）
- ドキュメントの構造と構成
網羅度: quick
出力: カテゴリ別のドキュメントファイルリスト（ユーザー向け、API、コントリビューション等）
```

エージェントの出力をカテゴリ分けに使用する。find/ls コマンドを手動で実行してはならない。

**ドキュメントのカテゴリ分け:**

| カテゴリ | ファイル | 優先度 |
|---------|---------|--------|
| **ユーザー向け** | README.md、docs/getting-started.md | 高 |
| **API** | API.md、docs/api/*.md、OpenAPI スペック | 高 |
| **コントリビューション** | CONTRIBUTING.md、docs/development.md | 中 |
| **アーキテクチャ** | docs/architecture/*.md、ADR | 中 |
| **変更履歴** | CHANGELOG.md、HISTORY.md | 低 |

**監査スコープの作成**（入力に基づくか、ユーザーに確認）:

```
Question: "どのドキュメントを監査しますか？"
Header: "スコープ"
Options:
- "すべてのドキュメント"（リリース前に推奨）
- "README とユーザーガイドのみ"
- "API ドキュメントのみ"
- "ファイルを指定します"
```

### フェーズ 2: コードとドキュメントのマッピング

**ゴール:** ドキュメントのセクションを対応するコードにマッピングする。

**事前マッピングコンテキスト（オーケストレーターがセクション構造のみ読み取り）:**

監査対象の各ドキュメントファイルについて（ファイルあたり200行以下、`subagent-contract` リミットに従う）:
1. ドキュメントファイルを直接読み取る（セクション見出しと構造のみ）
2. トップレベルの見出しを抽出（例: "## インストール"、"## API リファレンス"、"## 設定"）
3. これによりオーケストレーターが後続の検証のためにドキュメント構造を把握

**ドキュメント構造をユーザーに提示:**
```markdown
## ドキュメント: [ファイル名]

### 検出されたセクション:
1. [セクション見出し 1]
2. [セクション見出し 2]
...

### 監査スコープ:
[どのセクションをコードと照合して検証するか]
```

AskUserQuestion で確認する:
```
Question: "ドキュメント内のこれらのセクションを検出しました。乖離検出でどのセクションを優先しますか？"
Header: "優先順位"
Options:
- "すべてのセクションを監査"
- "[インストール、API などの高優先度セクション] に集中"
- "セクションを指定します"
```

**各ドキュメントファイルについて code-explorer を起動:**

```
code-explorer エージェントを起動:

このドキュメントを分析し、対応するコードを特定:

ドキュメント: [ファイルの内容またはパス]

タスク:
1. すべてのコード参照を抽出（ファイルパス、関数名、クラス）
2. 記載されたセットアップ/インストールコマンドを特定
3. ドキュメント化された API エンドポイントまたはインターフェースを検出
4. 記載された設定オプションをリスト化
5. バージョン番号や依存関係を記録

以下の形式でマッピングテーブルを返すこと:
| ドキュメントセクション | コード参照 | ファイルパス | ステータス |
|---------------------|-----------|-----------|---------|
| [セクション] | [参照] | [パス] | 未確認 |

網羅度: medium
```

エージェントのマッピングテーブル出力をそのまま使用する。手動でマッピングテーブルを作成してはならない。

### フェーズ 3: 乖離検出

**ゴール:** ドキュメントの記述を実際のコードと照合する。

**各マッピングについて正確性を検証する:**

**インストール/セットアップの乖離:**
```
code-explorer を起動:

以下のセットアップ手順が正確か検証:

ドキュメントの手順:
[セットアップステップ]

確認内容:
1. コマンドが動作するか？
2. 依存関係が正しく最新か？
3. 環境変数がドキュメント化されているか？
4. ステップの順序が正しいか？
```

**API の乖離:**
```
code-explorer を起動:

ドキュメント化された API と実装を比較:

ドキュメントのエンドポイント:
[API ドキュメントセクション]

確認内容:
1. エンドポイントが存在するか？
2. パラメータが一致するか？
3. レスポンス型が正確か？
4. エラーコードがドキュメント化されているか？
```

**設定の乖離:**
```
設定オプションを検証:

ドキュメントのオプション:
[設定セクション]

確認内容:
1. すべてのオプションがコードに存在するか？
2. デフォルト値が正確か？
3. ドキュメントに欠落しているオプションがないか？
```

### フェーズ 4: 指摘の分類

**ゴール:** 指摘をカテゴリ分けし優先順位付けする。

**各指摘の分類:**

| 深刻度 | 説明 | 例 |
|--------|------|------|
| **重大** | ドキュメントがユーザーを誤誘導し、エラーを引き起こす | 誤ったインストールコマンド、廃止された API |
| **高** | 重大な不正確さ | 必要なステップの欠落、誤ったパラメータ |
| **中** | 軽微な不正確さ | 古い例、コード内のタイプミス |
| **低** | 外観的または改善の余地 | スタイルの不整合、より明確にできる箇所 |

**信頼度スコアリング（0-100）:**
- 90-100: 確実な乖離、コードで検証済み
- 70-89: 乖離の可能性が高い、強い根拠あり
- 50-69: 乖離の可能性あり、要検証
- 50未満: 不確実、誤検知の可能性

**指摘のフィルタリング:** デフォルトでは信頼度80以上のみ報告。

### フェーズ 5: レポート生成

**ゴール:** 実行可能な監査結果を提示する。

```markdown
## ドキュメント監査レポート

### サマリー
- **監査ファイル数**: [N]
- **検出された乖離**: [N] 件
- **重大**: [N] | **高**: [N] | **中**: [N] | **低**: [N]

### 重大な問題（要修正）

#### 問題 1: [タイトル]（信頼度: 95）
**ファイル**: `README.md`、45行目
**タイプ**: インストール手順の乖離
**現在のドキュメント**:
```
npm install -g old-cli-name
```
**実際**:
```
npm install -g new-cli-name
```
**修正案**: パッケージ名を `new-cli-name` に更新

---

### 高優先度の問題

#### 問題 2: [タイトル]（信頼度: 88）
...

### 中優先度の問題
...

### 推奨事項

1. README.md のインストール手順を更新
2. OpenAPI スペックから API ドキュメントを再生成
3. docs/config.md に欠落している設定オプションを追加

### 検証チェックリスト

更新後に確認:
- [ ] インストール手順がクリーン環境で動作する
- [ ] API の例が期待どおりのレスポンスを返す
- [ ] 設定オプションがコードのデフォルト値と一致する
```

### フェーズ 6: ユーザーの判断

**ゴール:** 次のステップを決定する。

```
Question: "監査完了。[N] 件の問題が見つかりました。どうしますか？"
Header: "アクション"
Options:
- "すべての問題を自動修正"（10件未満の場合に推奨）
- "重大な問題のみ修正"
- "詳細レポートを表示して判断する"
- "レポートをファイルにエクスポート"
```

**自動修正の場合:**

```
technical-writer エージェントに委任:

特定された問題を修正してこのドキュメントを更新:

ファイル: [パス]
現在の内容: [内容]

修正すべき問題:
[修正案付きの問題リスト]

要件:
- ドキュメントの構造を維持
- 一貫したスタイルを維持
- 特定されたセクションのみ更新
```

---

## 監査パターン

### README.md 監査

よくある乖離ポイントを確認:
- インストールコマンドと依存関係
- クイックスタートの例
- 機能リスト vs 実際の機能
- バッジリンクとバージョン
- ライセンス情報

### API ドキュメント監査

以下の要素を確認:
- エンドポイントのパスとメソッド
- リクエスト/レスポンススキーマ
- 認証要件
- レート制限とクォータ
- エラーコードとメッセージ

### 設定ドキュメント監査

以下の要素を確認:
- 環境変数名
- デフォルト値
- 必須 vs 任意の設定
- 有効な値の範囲
- 廃止されたオプション

---

## /code-review との連携

このコマンドはドキュメント関連の変更が多い PR で `/code-review` の一環として呼び出せる:

```
PR がドキュメントまたはドキュメント化されたコードを変更する場合:
  /doc-audit --for [変更されたファイル] の実行を検討
```

---

## ルール（L1 - ハード）

- ALWAYS: 乖離の検証は想定ではなく実際のコードに対して行う
- NEVER: コード根拠なしに問題を報告してはならない
- ALWAYS: 具体的な修正推奨を含める
- NEVER: 重要なドキュメントについてユーザーの確認なしに自動修正してはならない

## デフォルト（L2 - ソフト）

- 報告の信頼度しきい値は80%
- ユーザー向けドキュメント（README、ガイド）を優先
- 正確性のため分析を code-explorer に委任
- 実行可能な修正推奨を生成

## ガイドライン（L3）

- consider: メジャーリリース前の実行を検討
- prefer: 変更されたコードの近くでドキュメントを修正する
- consider: CI/CD にドキュメント乖離チェックの追加を検討
- consider: 高速な結果のため監査スコープを絞る
