---
description: "本番環境の緊急修正ワークフロー - 最小限のプロセスで最大限の安全性"
argument-hint: "[問題の説明またはチケット参照]"
allowed-tools: Read, Write, Glob, Grep, Edit, Bash, AskUserQuestion, Task, TodoWrite
---

# /hotfix - 本番環境の緊急修正

## Language Mode

すべての出力は日本語で行う。詳細は `language-enforcement` スキルを参照。

---

緊急の本番環境問題に対する、速度と安全性のバランスを取った効率化ワークフロー。重要な安全チェックを維持しつつ、フル計画ワークフローをバイパスする。

## 目的

本番環境の問題には即座の対応が必要である。このコマンドは以下を提供する:

1. **速度** - 最小限のプロセスオーバーヘッド
2. **安全性** - 必須チェック（セキュリティ、テスト）を維持
3. **追跡可能性** - 何をなぜ変更したかの明確なドキュメント
4. **ロールバック対応** - 必要に応じて容易に元に戻せる

## 使用するとき

- ユーザーに影響する本番バグが発生中
- 重大なセキュリティ脆弱性が発見された
- 即座のコード修正が必要なサービス障害
- 緊急パッチが必要なデータ破損

## 使用しないとき

- 緊急でないバグ（`/quick-impl` または `/spec-plan` を使用）
- 機能開発（`/spec-plan` を使用）
- リファクタリング（`/spec-plan` を使用）
- CI の障害（`/ci-fix` を使用）

---

## ルール（L1 - ハード）

**これらのルールは緊急時にも適用される:**

- NEVER: 認証/データ処理コードに対するセキュリティバリデーションをスキップしてはならない
- NEVER: シークレットや認証情報をコミットしてはならない
- ALWAYS: hotfix ブランチを作成する（main/production に直接コミットしない）
- ALWAYS: プッシュ前に既存テストを実行する
- ALWAYS: 何をなぜ変更したかをドキュメント化する

---

## 実行手順

### フェーズ 1: 迅速なアセスメント（2-3分）

**ゴール:** 深い分析なしに問題を迅速に把握する。

**必須情報の収集:**

```
Question: "本番環境でどのような問題が発生していますか？"
Header: "問題"
Options:
- "ユーザーにエラーが表示される"
- "機能が動作しない"
- "セキュリティの問題"
- "パフォーマンスの劣化"
```

**CRITICAL: 具体的な情報を取得する（緊急時でも、明確さが誤った修正を防ぐ）:**

```
Question: "正しいものを修正するため、問題の詳細を教えてください。"
Header: "詳細"
Options:
- "エラーメッセージを見せます"
- "問題は [特定の機能/エンドポイント] にあります"
- "症状を説明します"
- "チケット/Issue のリンクがあります"
```

**説明が曖昧な場合**は AskUserQuestion で明確化する:

| ユーザーの発言 | 確認すべきこと |
|--------------|-------------|
| 「何か壊れている」 | どの機能か？ユーザーが使おうとすると何が起きるか？ |
| 「ユーザーにエラーが出ている」 | どんなエラーメッセージか？どのページ/操作で発生するか？ |
| 「動いていない」 | 期待される動作は？代わりに何が起きるか？ |
| 「パフォーマンスの問題」 | どの操作が遅いか？どの程度遅いか（秒数/タイムアウト）？ |

**曖昧な説明のまま進めてはならない** — 誤った修正は時間を浪費し、追加の問題を引き起こす可能性がある。

**具体情報を収集後、理解内容を確認する:**

```
Question: "問題を以下のように理解しました: [サマリー]。正しいですか？"
Header: "確認"
Options:
- "はい、その通りです"
- "補足します: [...]"
```

**簡易コンテキストチェック（code-explorer に委任）:**

```
code-explorer エージェントを起動:
タスク: hotfix 用の本番コンテキストを迅速に確認
分析内容:
- 最近のデプロイ（git log --oneline -5 --date=short）
- 本番ブランチの特定（main/master/production/release）
- 最新デプロイのタイムスタンプ
網羅度: quick
出力: 最近のコミット + 本番ブランチ名
```

親コンテキストで git 分析コマンド（git log、git diff、git show）を直接実行してはならない。コンテキストにはエージェントの出力を使用する。

**エラーハンドリング（時間重視）:**
code-explorer が失敗するか60秒以上かかる場合:
1. エージェントをスキップし手動の最小限チェックを実行: `git branch -a | grep -E "(main|master|prod)"`（単一コマンド、緊急時は許可）
2. 不明な場合はユーザーに本番ブランチを確認
3. 即座にフェーズ 2 に進む

### フェーズ 2: hotfix ブランチの作成（30秒）

**ゴール:** 安全なデプロイと容易なロールバックのために変更を分離する。

**CRITICAL: フェーズ 1 の code-explorer 出力から本番ブランチを使用する**

**注:** 単純な git 状態コマンド（fetch、checkout、ブランチ作成）は親コンテキストで直接実行可。これらは軽量な操作でコンテキストを消費しない。フェーズ 1 の制限は分析コマンドにのみ適用される。

```bash
# code-explorer が特定した本番ブランチを使用（'main' を仮定しない）
PROD_BRANCH=[フェーズ 1 エージェント出力の本番ブランチ]

git fetch origin
git checkout "$PROD_BRANCH"

# hotfix ブランチを作成
git checkout -b hotfix/[簡潔な説明]-$(date +%Y%m%d)
```

**code-explorer が本番ブランチを特定できなかった場合**、ユーザーに確認する:
```
Question: "本番ブランチはどれですか？"
Header: "ブランチ"
Options:
- "main"
- "master"
- "production"
- "指定します..."
```

**ブランチ命名:** `hotfix/[issue-id]-[簡潔な説明]`

例:
- `hotfix/fix-login-500-20250120`
- `hotfix/SEC-123-xss-patch`
- `hotfix/payment-timeout-fix`

### フェーズ 3: 問題の特定と修正（5-10分）

**ゴール:** 問題を見つけて最小限の修正を実施する。

**迅速な検索戦略（Explore エージェントに委任する）:**

Grep/Glob を直接実行してはならない。すべての検索を Explore エージェントに委任する:

```
Task ツールで subagent_type=Explore を起動:
タスク: 本番問題の迅速な特定

問題タイプに基づく検索アプローチ:
1. エラーメッセージが判明 → コードベースでエラーメッセージを検索
2. 機能が壊れている → エントリーポイント（API ルート、UI コンポーネント）から追跡
3. パフォーマンスの問題 → 影響を受けるコードパスの最近の変更を確認

問題タイプ: [フェーズ 1 から]
問題の詳細: [エラーメッセージ / 機能名 / 症状]

出力: 問題の具体的な file:line 参照
網羅度: quick
```

フェーズ 3 の実装にはエージェントの file:line 出力を使用する。コードベースを手動で検索してはならない。

**エラーハンドリング（緊急オーバーライド）:**
Explore エージェントが失敗するか90秒以上かかる場合:
1. 緊急直接検索を使用（hotfix のみ許可）: 正確なエラーメッセージの単一 Grep
2. エラーメッセージが見つからない場合、ユーザーに具体的なファイルパスのヒントを求める
3. ユーザー提供または最善の推測に基づく場所で手動修正を進める
4. コミットメッセージに「agent timeout - manual localization」と記載

**最小限の修正を実施する:**

| 原則 | 説明 |
|------|------|
| **最小の変更** | 壊れているところだけを修正し、それ以上は行わない |
| **リファクタリングなし** | 周辺コードの整理をしたい衝動に抵抗する |
| **新機能なし** | 「ついでに...」も行わない |
| **動作を維持** | 既存のパターンに正確に合わせる |

**実装は適切なスペシャリストに委任する**（速度のため model: haiku を使用）:

```
Task ツールで適切なスペシャリストを起動:
- フロントエンドの問題 → frontend-specialist（model: haiku）
- バックエンドの問題 → backend-specialist（model: haiku）
- 設定の問題 → 直接変更可能（1行のみ）

プロンプト:
緊急 hotfix - 最小限の修正のみ実施。
ファイル: [Explore からの file:line]
問題: [簡潔な説明]
修正: [必要な具体的変更]

制約:
- 単一の論理的変更のみ
- リファクタリングなし
- 既存パターンに合わせる
```

**エラーハンドリング（緊急オーバーライド）:**
スペシャリストエージェントが失敗するか2分以上かかる場合:
1. エージェントの部分的な出力に利用可能な修正がないか確認
2. 明示的な単一ファイルフォーカスでリトライ
3. リトライも失敗した場合: ユーザーに通知し緊急手動修正オプションを提案:
   ```
   Question: "エージェントがタイムアウトしました。これは緊急事態です - 手動で修正を適用してよいですか？"
   Header: "緊急オーバーライド"
   Options:
   - "はい、最小限の修正を直接適用する"（リスクを理解した上で）
   - "いいえ、待ってエージェントをリトライ"
   - "hotfix を中止し /debug を試す"
   ```
4. ユーザーが手動修正を承認した場合: 最小限の変更を適用し、コミットに「emergency manual fix」と記載

**直接変更が許可されるのは以下の場合のみ:**
- 1行の設定値変更
- 環境変数の更新
- フィーチャーフラグの切り替え

### フェーズ 4: 安全性検証（2-3分）

**ゴール:** 修正が他を壊していないことを確認する。

**CRITICAL: 検証は qa-engineer エージェントに委任する（親コンテキストでテストを直接実行してはならない）:**

```
qa-engineer エージェントを起動:

タスク: hotfix の安全性検証を実行

変更ファイル:
[フェーズ 3 で変更したファイルリスト]

検証内容:
1. テストを実行（必須）
2. リンターを実行（30秒以内なら）
3. 型チェックを実行（30秒以内なら）

出力:
- テスト結果（PASS/FAIL）
- リント結果（PASS/FAIL/SKIPPED）
- 型チェック結果（PASS/FAIL/SKIPPED）
- 失敗がある場合はエラー詳細
```

検証結果にはエージェントの出力を使用する。親コンテキストでテスト/リントコマンドを直接実行してはならない。

**エラーハンドリング（緊急オーバーライド）:**
qa-engineer が失敗するか2分以上かかる場合:
1. エージェントの部分的な出力に利用可能な結果がないか確認
2. スコープを簡略化してリトライ（テストのみ）
3. リトライも失敗した場合、緊急手動オプションを提示:
   ```
   Question: "検証エージェントがタイムアウトしました。どう進めますか？"
   Header: "緊急検証"
   Options:
   - "最小限のテストスイートを手動で実行"（単一テストコマンド）
   - "検証をスキップ（デプロイ前に手動で検証します）"
   - "hotfix を中止して調査"
   ```
4. コミットメッセージに検証アプローチを記載

**セキュリティチェック（L1 - 認証/データコードでは NEVER スキップ）:**

```
修正が認証、認可、またはデータ処理に関わる場合:
- security-auditor に簡易セキュリティレビューを委任
- 変更されたコードのみに焦点
- 合格してから次に進む
```

**テストが失敗した場合（qa-engineer の出力より）:**
- テストがバグをテストしていた場合はテストを修正（バグが「正常」な動作だった場合）
- テストが新しい問題を明らかにした場合はコードを修正
- 失敗するテストをスキップしてはならない

### フェーズ 5: ドキュメント化とコミット（1-2分）

**ゴール:** 監査とロールバックのための追跡可能なコミットを作成する。

**コミットメッセージの形式:**

```bash
git add [変更ファイル]
git commit -m "$(cat <<'EOF'
hotfix: [簡潔な説明]

Issue: [チケット/説明]
Root cause: [1行の説明]
Fix: [1行の説明]

Affected: [影響を受ける機能のリスト]
Tested: [検証方法]
Rollback: git revert [this-commit-sha]
EOF
)"
```

**例:**

```
hotfix: メールアドレスに特殊文字を含むユーザーのログイン500エラーを修正

Issue: メールに + を含むユーザーがログイン時に500エラー
Root cause: API 呼び出し前に URL エンコーディングが適用されていない
Fix: メールパラメータに encodeURIComponent を追加

Affected: ログインフローのみ
Tested: test+user@example.com での手動テスト、ユニットテスト合格
Rollback: git revert abc123
```

### フェーズ 6: プッシュとデプロイ

**ゴール:** 修正を本番環境に迅速に反映する。

**hotfix ブランチをプッシュ:**

```bash
git push -u origin hotfix/[ブランチ名]
```

**デプロイオプション:**

| 方法 | 使用する場面 |
|------|-------------|
| **main にマージ、自動デプロイ** | 標準 CI/CD が整備されている場合 |
| **ブランチから直接デプロイ** | 緊急オーバーライドが利用可能な場合 |
| **リリースブランチにチェリーピック** | リリースブランチワークフローの場合 |

**ユーザーに確認する:**

```
Question: "修正の準備ができました。どのようにデプロイしますか？"
Header: "デプロイ"
Options:
- "main への PR を作成"（推奨）
- "手動でデプロイします"
- "デプロイコマンドを表示"
```

### フェーズ 7: ポスト hotfix

**ゴール:** 修正が追跡されフォローアップされることを確認する。

**サマリーを作成:**

```markdown
## hotfix 完了

### 問題
[簡潔な説明]

### 適用された修正
| ファイル | 変更内容 |
|---------|---------|
| `src/api/auth.ts:45` | URL エンコーディングを追加 |

### 検証
- [x] テスト合格
- [x] セキュリティチェック（該当する場合）
- [x] 手動検証

### デプロイ
- ブランチ: `hotfix/[名前]`
- PR: [作成された場合はリンク]

### 必要なフォローアップ
- [ ] このケースのリグレッションテストを追加
- [ ] 根本原因がより大きな問題を示唆していないか確認
- [ ] 必要に応じてモニタリング/アラートを更新
```

**フォローアップの提案:**

```
hotfix がデプロイされました。推奨されるフォローアップ:
1. 再発を監視
2. 適切なリグレッションテストを作成（大規模な場合は /spec-plan を使用）
3. パターン問題の場合は根本原因分析
```

---

## hotfix チェックリスト

緊急時のクイックリファレンス:

```
[ ] 1. 問題を把握（2-3分）
[ ] 2. hotfix ブランチを作成
[ ] 3. 問題を特定して修正（最小限の変更）
[ ] 4. テストを実行（必須）
[ ] 5. セキュリティチェック（認証/データの場合）
[ ] 6. フルコンテキスト付きでコミット
[ ] 7. プッシュしてデプロイ
[ ] 8. フォローアップ用にドキュメント化
```

---

## ロールバック手順

hotfix が新たな問題を引き起こした場合:

```bash
# オプション 1: コミットをリバート
git revert [hotfix-commit-sha]
git push

# オプション 2: 以前のバージョンをデプロイ
git checkout main
git reset --hard [pre-hotfix-sha]
git push --force  # 危険: チームと調整すること

# オプション 3: リリースブランチにリバートをチェリーピック
git checkout release
git cherry-pick -n [revert-commit]
git push
```

---

## 時間予算

目標合計時間: **15-20分**

| フェーズ | 目標 | 最大 |
|---------|------|------|
| アセスメント | 2-3分 | 5分 |
| ブランチセットアップ | 30秒 | 1分 |
| 特定と修正 | 5-10分 | 15分 |
| 検証 | 2-3分 | 5分 |
| コミット/プッシュ | 1-2分 | 3分 |

**30分を超過した場合:** 問題は hotfix よりも複雑な可能性がある。以下を検討:
- 一時的な緩和策（フィーチャーフラグ、ロールバック）
- `/spec-plan` による適切な修正へのエスカレーション

---

## 他のコマンドとの比較

| 側面 | /hotfix | /quick-impl | /spec-plan |
|------|---------|-------------|------------|
| **速度** | 最速 | 速い | 入念 |
| **プロセス** | 最小限 | 軽量 | 計画→レビュー→実装 |
| **探索** | 迅速のみ | 軽量 | 並列エージェント |
| **テスト** | 必須 | 期待される | 包括的 |
| **ドキュメント** | コミットメッセージ | 軽量 | フル仕様書 |
| **最適な用途** | 緊急時 | 小規模タスク | 機能開発 |
